<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" 
   "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Generated by perltidy on Tue May  9 19:11:04 2023 -->
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>mp3info.pl</title>
<link rel="stylesheet" href="mp3-style.css" type="text/css" /></head>
<body>
<a name="-top-"></a>
<h1>mp3info.pl</h1>
<!-- BEGIN CODE INDEX --><a name="code-index"></a>
<ul>
<li><a href="#Discussion" >Discussion</li>
<li><a href="#Script" >Script</li>
<li><a href="#__END__-">__END__ (Diagnostics)</a></li>
<li><a href="#EOF-">EOF</a></li>
</ul>
<!-- END CODE INDEX -->
<hr />
<h2><a name="Discussion">Discussion</a></h2>
<p>This script exists to (a) scratch an immediate itch and (b) experiment with a few modules. 
No claim is made to best usage of any of these features! The Itch was scratched, and pudding was proofed.</p>

<p>The Itch was that in moving old podcast files off a modest M.2 SSD to archival spinning rust drive 
(which is normally kept Read-only mounted for safety),
I did not want to <b>rely</b> on Rhythmbox or other music/pod player being sane about browsing/playing a read-only drive where it couldn't mark things PLAYED.
I did need to move most of my older mp3, ogg, etc collection that wasn't "in queue" to larger passive storage to make space.
But i didn't want to lose the ability to search by track title etc, which usually aren't fully encoded in filenames.
As i expected, there's a CPAN module for accessing mp3 etc meta-data tags.
So it should be trivial to recursively write HTML indices for directories containing MP3s, with links that will play a file, right?
</p>

<h3>Desired Output</h3>

<p>Directory HTML pages consisting of listings for sudirectories</p>

<div style="margin-left:5em; background: #fee;width:80em;overflow:auto" >
<pre>
&lt;br />&lt;div class=subdir>&lt;a href="./Following%20On%20in%20India%20Cricket%20Podcast/directory.html">/media/wdr/bulkstorage/wdr/Music/Following On in India Cricket Podcast/&lt;/a>&lt;/div><br />
</pre>
</div>

<p>which displays as</p>


<div style="margin-left:5em; background: #fee;width:40em;overflow:auto;" >
<samp >
<br /><div class=c><span style="color:blue;text-decoration-line: underline;font-family:monospace;"><!--<a href="./Following%20On%20in%20India%20Cricket%20Podcast/directory.html">-->/media/wdr/bulkstorage/wdr/Music/Following On in India Cricket Podcast/<!-- </a> --> </span></div><br />
</samp></div>


<p>and for MP3, OGG, etc audio files contained in the directory, emit</p>

<div style="margin-left:5em; background: #fee;width:80em;overflow:auto" >
<pre>
&lt;div class=program> &lt;!-- /media/wdr/bulkstorage/wdr/Music/Wynalda%20for%20the%20Win/BLU5671872590.mp3 --&gt;
&lt;br />&lt;span class=attr>Song:	 The USA vs. Mexico Preview Show&lt;/span>
&lt;br />&lt;span class=attr>Album:	 Wynalda for the Win&lt;/span>
&lt;br />&lt;span class=attr>size: 66M&lt;/span>
&lt;br />&lt;span class=attr>date: 2021-11-27&lt;/span>
&lt;br />&lt;a href="BLU5671872590.mp3">PLAY&lt;/a>
&lt;/div>
</pre>
</div>

<p>which renders as</p>
<div style="margin-left:5em; background: #fee;width:40em;overflow:auto;">
<samp >
<div class=c> <!-- /media/wdr/bulkstorage/wdr/Music/Wynalda%20for%20the%20Win/BLU5671872590.mp3 -->
<br />Song:	 The USA vs. Mexico Preview Show
<br />Album:	 Wynalda for the Win
<br />size: 66M
<br />date: 2021-11-27
<br /><span style="color:blue;text-decoration-line: underline;font-family:monospace;"><!--<a href="BLU5671872590.mp3">-->PLAY<!-- </a> --></span>
</div>
</samp>
</div>

<p>(<i>No, those files aren't on the server, so clicking those <span style="color:blue;text-decoration-line: underline;">blue links</span>  is pointless.</i>)</p>
<p>Other itches were experimenting with <b><code>Syntax::Keyword::Try</code></b> and indented HEREDOCs. 
Use of <code>try catch</code> is why the (ab)use of <code>redo OPEN</code> instead of testing directory writability with <code>File::stat</code> like a sane person. 
This overly complex idiom is appropriate for situations where the problem is <i>not</i> foreseeable; this problem is, but i wsa scouting code>Syntax::Keyword::Try</code> 
for a much larger usecase elsewhere.</p>
<p>Randal (<code>merlyn</code>) and Jerrad (<code>belg4mit</code>, <code>pthbb</code>) made some useful observations for anyone interested in modifying this:</p>
<ul>
<li>it would be simpler to do a filestat earlier; yeah, but i didn't want, because reasons (above).</li>
<li>if it were running anywhere other than my desktop where User=Group, it would be best practice 
to SAVE and RESTORE directory permissions explicitly, as opposed to assuming that if it wasn't writable, 
both <code>go+w</code> were previously off.</li>
<li><code>Path::Tiny</code> has <code>stringify</code> as operator <code>""</code> overload so i could say <code>"$file"</code> instead of calling <code>stringify</code> explicitly.</li>
<li>An HTML table would be more usuable output UX.</li>
<li>trim the path to relative so it's relocatable and avoid display of repeated text!</li>
</ul>
<p>All of these are valid criticism.  But it was a one-afternoon minimum-viable itch-scratch that made my space-clearing "safe". 
It suffices for its intended purposed. Any reuse should apply the above observations! </p>
<hr />
<a name="Script"><!-- contents of filename: mp3info.pl --></a>

<pre>
   1 #!/usr/bin/perl -w
   2 <span class="c">#</span>
   3 <span class="c"># USAGE</span>
   4 <span class="c">#</span>
   5 <span class="c"># perl mp3info.pl $PODS/&#39;Podcast Name In Quotes&#39;</span>
   6 <span class="c">#</span>
   7 <span class="c"># MUSIC_PATH=$HOME/Music</span>
   8 <span class="c"># MUSIC_PATH=/media/$USER/bulkstorage/$USER/Music</span>
   9 <span class="c"># MUSIC_PATH=$HOME/Music/Podcasts</span>
  10 <span class="c"># find $MUSIC_PATH  -type d -print0 | xargs -0 perl ./mp3info.pl</span>
  11 <span class="c">#</span>
  12 <span class="c"># the -print0 and -0 are necessary since Album dirs have spaces :-/</span>
  13 <span class="c">#</span>
  14 <span class="c"># NB: for R/O bulk archive drive mentioned, need to </span>
  15 <span class="c">#    sudo mount -o remount,rw $mount_point  # before</span>
  16 <span class="c">#    sudo mount -o remount,ro $mount_point  # after </span>
  17                
  18 <span class="k">use</span> <span class="w">MP3::Tag</span><span class="sc">;</span>
  19 <span class="c"># Mutated from MP#::Tag demo program into tool to generate an</span>
  20 <span class="c"># HTML Directory listings of MP3 etc </span>
  21 <span class="c"># in new form, instead of a list of files on STDIN, </span>
  22 <span class="c"># it will take a list of directories on ARGV,</span>
  23 <span class="c"># and write a directory.hml into the directory</span>
  24 
  25 <span class="c"># BUGS</span>
  26 <span class="c"># has same tags for HTML as MP3; can&#39;t answer &quot;is it really audio&quot;,</span>
  27 <span class="c"># so will likely catalog nohup.out or something !!</span>
  28 
  29 <span class="c"># original example comments</span>
  30 <span class="c"># define how autoinfo tries to get information</span>
  31 <span class="c"># default:</span>
  32 <span class="c"># MP3::Tag-&gt;config(&quot;autoinfo&quot;,&quot;ID3v2&quot;,&quot;ID3v1&quot;,&quot;filename&quot;);</span>
  33 <span class="c"># don&#39;t use ID3v2:</span>
  34 <span class="c"># MP3::Tag-&gt;config(&quot;autoinfo&quot;,&quot;ID3v1&quot;,&quot;filename&quot;);</span>
  35 
  36 <span class="k">use</span> <span class="v">v5.030</span><span class="sc">;</span>
  37 
  38 <span class="k">use</span> <span class="w">URI::Encode</span> <span class="q">qw(uri_encode uri_decode)</span><span class="sc">;</span>
  39 <span class="k">use</span> <span class="w">POSIX</span> <span class="q">qw/strftime/</span><span class="sc">;</span>
  40 <span class="k">use</span> <span class="w">Path::Tiny</span><span class="sc">;</span>
  41 <span class="k">use</span> <span class="w">File::stat</span><span class="sc">;</span>
  42 <span class="k">use</span> <span class="w">Readonly</span><span class="sc">;</span>
  43 <span class="k">use</span> <span class="w">Syntax::Keyword::Try</span> <span class="q">qw( try :experimental )</span><span class="sc">;</span>
  44 
  45 <span class="w">Readonly</span> <span class="k">my</span> <span class="i">$page_filename</span> <span class="cm">=&gt;</span> <span class="q">&#39;directory.html&#39;</span><span class="sc">;</span>
  46 
  47 <span class="c"># @TODO probably need some UTF declarations</span>
  48 <span class="c"># @TODO add link to a vanilla CSS file ? </span>
  49 <span class="c"># @TODO do we read css for bulk Music from $HOME/Music ?</span>
  50 <span class="c"># @TODO should sort files by either name or f/s date or better Tags date (and maybe dirs first?)</span>
  51 
  52 <span class="j">DIRECTORY:</span>
  53 <span class="k">for</span> <span class="k">my</span> <span class="i">$dir_arg</span> <span class="s">(</span><span class="i">@ARGV</span><span class="s">)</span><span class="s">{</span>
  54 
  55     <span class="k">warn</span> <span class="q">&quot;&gt;&gt; entering $dir_arg&quot;</span><span class="sc">;</span>
  56 
  57     <span class="k">my</span> <span class="i">$dir</span> = <span class="i">path</span><span class="s">(</span><span class="i">$dir_arg</span><span class="s">)</span><span class="sc">;</span>
  58 
  59     <span class="k">die</span> <span class="q">&quot;$dir_arg not a directory&quot;</span> <span class="k">unless</span> <span class="i">$dir</span><span class="i">-&gt;is_dir</span> <span class="sc">;</span>
  60 
  61     <span class="k">my</span> <span class="i">@Files</span> = <span class="i">$dir</span><span class="i">-&gt;children</span><span class="sc">;</span>
  62     <span class="c"># warn &#39;&gt;&gt;&gt;&gt;&#39;, join(q(,), map{&quot;&#39;$_&#39;&quot;} @Files); # DEBUG</span>
  63 
  64     <span class="c">## open directory.html FH here</span>
  65     <span class="k">my</span> <span class="i">$fh</span><span class="sc">;</span>
  66     <span class="k">my</span> <span class="i">$dodge</span>=<span class="q">q()</span><span class="sc">;</span>
  67 
  68     <span class="j">OPEN:</span>
  69     <span class="k">while</span> <span class="s">(</span> ! <span class="i">$fh</span> <span class="s">)</span><span class="s">{</span>
  70         <span class="i">try</span> <span class="s">{</span>
  71              <span class="i">$dir</span><span class="i">-&gt;chmod</span><span class="s">(</span><span class="q">&#39;ug+w&#39;</span><span class="s">)</span> <span class="k">if</span> <span class="i">$dodge</span> <span class="k">eq</span> <span class="q">&#39;dir_perm&#39;</span><span class="sc">;</span>  <span class="c"># Very Temporary</span>
  72 
  73              <span class="i">$fh</span> = <span class="i">$dir</span><span class="i">-&gt;child</span><span class="s">(</span><span class="i">$page_filename</span><span class="s">)</span><span class="i">-&gt;filehandle</span><span class="s">(</span><span class="q">&#39;&gt;&#39;</span><span class="cm">,</span> <span class="q">&#39;:raw:utf8_strict&#39;</span><span class="s">)</span><span class="sc">;</span>
  74 
  75              <span class="i">$dir</span><span class="i">-&gt;chmod</span><span class="s">(</span><span class="q">&#39;ug-w&#39;</span><span class="s">)</span> <span class="k">if</span> <span class="i">$dodge</span> <span class="k">eq</span> <span class="q">&#39;dir_perm&#39;</span><span class="sc">;</span> <span class="c"># I said Very Temporary!</span>
  76          <span class="s">}</span>
  77          <span class="k">catch</span> <span class="s">(</span><span class="i">$e</span> =~ <span class="q">m{Error open.*Permission denied}i</span> <span class="s">)</span> <span class="s">{</span>
  78              <span class="k">warn</span> <span class="q">&quot;caught &#39;$e&#39;; workaround ...&quot;</span><span class="sc">;</span>
  79              <span class="k">if</span> <span class="s">(</span><span class="i">$dodge</span><span class="s">)</span><span class="s">{</span>
  80                  <span class="k">warn</span> <span class="q">&quot;already dodged $dodge workaround, skipping &#39;$dir&#39;&quot;</span><span class="sc">;</span>
  81                  <span class="k">next</span> <span class="j">DIRECTORY</span><span class="sc">;</span>
  82              <span class="s">}</span>
  83              <span class="i">$dodge</span> = <span class="q">&#39;dir_perm&#39;</span><span class="sc">;</span> 
  84              <span class="k">redo</span> <span class="j">OPEN</span><span class="sc">;</span>
  85              <span class="s">}</span>
  86          <span class="k">catch</span> <span class="s">(</span><span class="i">$e</span><span class="s">)</span> <span class="s">{</span>
  87              <span class="k">warn</span> <span class="q">&quot;Unexpected exception caught &#39;$e&#39;, exiting $dir&quot;</span><span class="sc">;</span>
  88              <span class="k">next</span> <span class="j">DIRECTORY</span><span class="sc">;</span>
  89          <span class="s">}</span>
  90      <span class="s">}</span>
  91 
  92 
  93 
  94     <span class="k">say</span> <span class="i">$fh</span> <span class="h">&lt;&lt;~&quot;EOF&quot;</span><span class="sc">;</span>
  95 <span class="hh">    &lt;html&gt;</span>
  96 <span class="hh">    &lt;head&gt;</span>
  97 <span class="hh">    &lt;title&gt;Directory of $dir Audio Files&lt;/title&gt;</span>
  98 <span class="hh">    &lt;/head&gt;</span>
  99 <span class="hh">    &lt;body&gt;</span>
 100 <span class="h">    EOF</span>
 101 
 102     <span class="j">FILE:</span>
 103     <span class="k">for</span> <span class="k">my</span> <span class="i">$file</span> <span class="s">(</span><span class="k">grep</span> <span class="s">{</span> <span class="i">$_</span><span class="i">-&gt;stringify</span> !~ <span class="q">m/[.]htm[l]?$/</span> <span class="s">}</span> <span class="i">@Files</span><span class="s">)</span><span class="s">{</span>
 104             <span class="k">if</span> <span class="s">(</span><span class="i">$file</span><span class="i">-&gt;is_dir</span><span class="s">)</span><span class="s">{</span>
 105                 <span class="k">warn</span> <span class="i">$file</span><span class="i">-&gt;stringify</span><span class="cm">,</span> <span class="q">&quot; is directory, not recursing, do it separately after&quot;</span><span class="sc">;</span>
 106                 <span class="k">say</span> <span class="i">$fh</span> <span class="k">sprintf</span> <span class="q">&#39;&lt;br /&gt;&lt;div class=subdir&gt;&lt;a href=&quot;./%s/%s&quot;&gt;%s/&lt;/a&gt;&lt;/div&gt;&lt;br /&gt;&#39;</span><span class="cm">,</span> <span class="i">uri_encode</span><span class="s">(</span><span class="i">$file</span><span class="i">-&gt;basename</span><span class="s">)</span><span class="cm">,</span> <span class="i">uri_encode</span><span class="s">(</span><span class="i">$page_filename</span><span class="s">)</span><span class="cm">,</span> <span class="i">$file</span><span class="sc">;</span>
 107                 <span class="k">next</span><span class="sc">;</span>
 108             <span class="s">}</span>
 109             <span class="k">if</span> <span class="s">(</span><span class="k">my</span> <span class="i">$mp3</span>=<span class="w">MP3::Tag</span><span class="w">-&gt;new</span><span class="s">(</span><span class="i">$file</span><span class="i">-&gt;stringify</span><span class="s">)</span><span class="s">)</span> <span class="s">{</span>
 110                 <span class="k">say</span> <span class="i">$fh</span> <span class="k">sprintf</span> <span class="q">&#39;&lt;div class=program&gt; &lt;!-- %s --&gt;&#39;</span><span class="cm">,</span> <span class="w">uri_encode</span> <span class="i">$file</span><span class="i">-&gt;stringify</span><span class="sc">;</span>
 111                 <span class="c"># my @tags = $mp3-&gt;get_tags(); </span>
 112                 <span class="c"># say $fh sprintf &#39;&lt;!-- %s --&gt;&#39;, join q(,), map{uri_encode $_} @tags;</span>
 113                 <span class="k">my</span> <span class="i">$stat</span>= <span class="i">$file</span><span class="i">-&gt;stat</span><span class="sc">;</span>
 114                 <span class="c"># debug:</span>
 115                 <span class="c"># print &quot;$file (Tags: &quot;, join(&quot;, &quot;,$mp3-&gt;get_tags),&quot;)\n&quot;;</span>
 116                 <span class="k">my</span> <span class="i">%Info</span><span class="sc">;</span>
 117                 <span class="k">my</span> <span class="i">@keys</span> = <span class="q">qw/Song Track Artist Album Comment/</span> <span class="sc">;</span>
 118                 <span class="s">(</span><span class="i">@Info</span>{<span class="i">@keys</span>}<span class="s">)</span>=<span class="i">$mp3</span><span class="i">-&gt;autoinfo</span><span class="sc">;</span>
 119                 <span class="k">for</span> <span class="k">my</span> <span class="i">$k</span> <span class="s">(</span><span class="i">@keys</span><span class="s">)</span><span class="s">{</span>
 120                     <span class="c"># say $fh &quot;&lt;!-- &quot;, $k, q(:), $Info{$k}, &quot;--&gt;&quot;;  # Debug</span>
 121                     <span class="k">say</span> <span class="i">$fh</span> <span class="q">&quot;&lt;br /&gt;&lt;span class=attr&gt;$k:\t $Info{$k}&lt;/span&gt;&quot;</span> <span class="k">if</span> <span class="i">$Info</span>{<span class="i">$k</span>}<span class="sc">;</span>
 122                 <span class="s">}</span>
 123                 <span class="k">say</span> <span class="i">$fh</span> <span class="k">sprintf</span> <span class="q">&quot;&lt;br /&gt;&lt;span class=attr&gt;size: %dM&lt;/span&gt;\n&lt;br /&gt;&lt;span class=attr&gt;date: %s&lt;/span&gt;&quot;</span><span class="cm">,</span> <span class="k">int</span><span class="s">(</span><span class="i">$stat</span><span class="i">-&gt;size</span>/<span class="s">(</span><span class="n">1</span>&lt;&lt;<span class="n">20</span><span class="s">)</span><span class="s">)</span><span class="cm">,</span> <span class="w">POSIX::strftime</span> <span class="q">&quot;%F&quot;</span><span class="cm">,</span> <span class="k">localtime</span><span class="s">(</span><span class="i">$stat</span><span class="i">-&gt;mtime</span><span class="s">)</span>  <span class="sc">;</span>
 124                 <span class="k">say</span> <span class="i">$fh</span> <span class="k">sprintf</span> <span class="q">&#39;&lt;br /&gt;&lt;a href=&quot;%s&quot;&gt;PLAY&lt;/a&gt;&#39;</span><span class="cm">,</span> <span class="w">uri_encode</span> <span class="i">$file</span><span class="i">-&gt;relative</span><span class="s">(</span><span class="i">$file</span><span class="i">-&gt;parent</span><span class="s">)</span><span class="sc">;</span>
 125                 <span class="k">say</span> <span class="i">$fh</span> <span class="q">&quot;&lt;/div&gt;\n&quot;</span><span class="sc">;</span>
 126             <span class="s">}</span> <span class="c"># end if mp3</span>
 127         <span class="s">}</span> <span class="c"># end for files </span>
 128         <span class="k">say</span> <span class="i">$fh</span> <span class="h">&lt;&lt;~&#39;EOF&#39;</span><span class="sc">;</span>
 129 <span class="hh">        &lt;/body&gt;</span>
 130 <span class="hh">        &lt;/html&gt;</span>
 131 <span class="h">        EOF</span>
 132 
 133         <span class="c"># close directory.html FH here</span>
 134 
 135 <span class="s">}</span> <span class="c"># end dirs</span>
 136 
 137 
<a name="__END__-"></a> 138 <span class="k">__END__</span>
 139 
 140 <span class="q">Diagnostics</span>
 141 
 142 
 143 <span class="q">&gt;&gt; entering /media/wdr/bulkstorage/wdr/Music/Science Unscripted - Daily news on COVID-19 at ./mp3info.pl line 54.</span>
 144 <span class="q">Ridiculously large tag size: 1945578; file size 920474 at .../lib/perl5/MP3/Tag/ID3v2.pm line 2081.</span>
 145 
<a name="EOF-"></a></pre>
</body>
</html>
